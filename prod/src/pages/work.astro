---
import { getImage } from 'astro:assets';
import BaseLayout from '../layouts/BaseLayout.astro';
import WorkSection from '../components/work/Work.astro';
import workData from '../data/work.json';

// Import all photos from the artifacts directory
const imageModules = import.meta.glob<{ default: ImageMetadata }>(
  '/public/artifacts/PICTURES/*.{jpg,jpeg,png}',
  { eager: true }
);

// Pre-optimize all photos at build time
const optimizedPhotos = await Promise.all(
  workData.photos.map(async (photo) => {
    const imagePath = `/public${photo.src}`;
    const imageModule = imageModules[imagePath];

    if (imageModule) {
      const optimized = await getImage({
        src: imageModule.default,
        format: 'webp',
        quality: 80,
      });
      return { ...photo, src: optimized.src };
    }
    return photo;
  })
);
---

<BaseLayout title="My Work - Mike Lacey">
  <WorkSection
    credits={workData.credits}
    photos={optimizedPhotos}
    interviews={workData.interviews}
  />
</BaseLayout>
